<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©ç»„ä»¶é›†æˆæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            transition: all 0.3s ease;
        }
        .test-passed {
            background-color: #f0f9ff;
            border-left: 4px solid #22c55e;
        }
        .test-failed {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        .test-running {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-6 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center">èŠå¤©ç»„ä»¶é›†æˆæµ‹è¯•</h1>
        
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex gap-4 mb-4">
                <button onclick="runAllTests()" id="runBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    è¿è¡Œæ‰€æœ‰æµ‹è¯•
                </button>
                <button onclick="clearResults()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    æ¸…é™¤ç»“æœ
                </button>
            </div>
            
            <!-- æµ‹è¯•çŠ¶æ€æ˜¾ç¤º -->
            <div id="testStatus" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <div class="text-sm text-blue-600">å½“å‰è¿è¡Œ:</div>
                <div class="font-semibold" id="currentTest">ç­‰å¾…å¼€å§‹...</div>
            </div>
            
            <!-- æµ‹è¯•ç»Ÿè®¡ -->
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalTests">0</div>
                    <div class="text-sm text-gray-600">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="passedTests">0</div>
                    <div class="text-sm text-gray-600">é€šè¿‡</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600" id="failedTests">0</div>
                    <div class="text-sm text-gray-600">å¤±è´¥</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="passRate">0%</div>
                    <div class="text-sm text-gray-600">é€šè¿‡ç‡</div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœ -->
        <div id="testResults" class="space-y-4">
            <!-- æµ‹è¯•ç»“æœå°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3001/api/test';
        let testResults = [];
        let isRunning = false;

        const testSuites = [
            {
                name: 'åŸºç¡€è¿æ¥æµ‹è¯•',
                tests: [
                    { name: 'æµ‹è¯•æ•°æ®åº“è¿æ¥', fn: testDatabaseConnection },
                    { name: 'æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§', fn: testAPIEndpoints },
                    { name: 'æµ‹è¯•è®¤è¯çŠ¶æ€', fn: testAuthentication }
                ]
            },
            {
                name: 'å¯¹è¯åŠŸèƒ½æµ‹è¯•',
                tests: [
                    { name: 'è·å–å¯ç”¨æ¨¡å‹', fn: testGetAvailableModels },
                    { name: 'æµ‹è¯•å¯¹è¯åˆ›å»º', fn: testCreateConversation },
                    { name: 'æµ‹è¯•æ¶ˆæ¯å‘é€', fn: testSendMessage }
                ]
            },
            {
                name: 'ç»„ä»¶æ¸²æŸ“æµ‹è¯•',
                tests: [
                    { name: 'æµ‹è¯•æ¶ˆæ¯ç»„ä»¶', fn: testMessageComponents },
                    { name: 'æµ‹è¯•è¾“å…¥ç»„ä»¶', fn: testInputComponents },
                    { name: 'æµ‹è¯•è®¾ç½®ç»„ä»¶', fn: testSettingsComponents }
                ]
            },
            {
                name: 'æ€§èƒ½æµ‹è¯•',
                tests: [
                    { name: 'æµ‹è¯•å“åº”æ—¶é—´', fn: testResponseTime },
                    { name: 'æµ‹è¯•å†…å­˜ä½¿ç”¨', fn: testMemoryUsage },
                    { name: 'æµ‹è¯•å¹¶å‘å¤„ç†', fn: testConcurrentRequests }
                ]
            }
        ];

        // æµ‹è¯•å‡½æ•°å®ç°
        async function testDatabaseConnection() {
            const response = await fetch(`${API_BASE}/db-status`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Database check failed');
        }

        async function testAPIEndpoints() {
            const endpoints = ['/db-status', '/ai-config', '/models'];
            for (const endpoint of endpoints) {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`Endpoint ${endpoint} failed`);
            }
        }

        async function testAuthentication() {
            // æ¨¡æ‹Ÿè®¤è¯æµ‹è¯•
            localStorage.setItem('token', 'test-token');
            const response = await fetch('http://127.0.0.1:3001/api/chat/conversations', {
                headers: { 'Authorization': 'Bearer test-token' }
            });
            // 401æˆ–200éƒ½è¡¨ç¤ºè®¤è¯ç³»ç»Ÿåœ¨å·¥ä½œ
            if (response.status !== 401 && response.status !== 200) {
                throw new Error(`Unexpected auth response: ${response.status}`);
            }
        }

        async function testGetAvailableModels() {
            const response = await fetch(`${API_BASE}/models`);
            if (!response.ok) throw new Error('Models API failed');
            const data = await response.json();
            if (!data.success || !Array.isArray(data.data.models)) {
                throw new Error('Invalid models response');
            }
        }

        async function testCreateConversation() {
            const response = await fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'æµ‹è¯•æ¶ˆæ¯' })
            });
            if (!response.ok) throw new Error('Conversation creation failed');
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Creation failed');
        }

        async function testSendMessage() {
            // è¿™ä¸ªæµ‹è¯•ä¾èµ–äºä¹‹å‰çš„ä¼šè¯åˆ›å»º
            // è¿™é‡Œåªæµ‹è¯•APIç«¯ç‚¹æ˜¯å¦å¯è®¿é—®
            console.log('Message sending test - endpoint availability');
        }

        async function testMessageComponents() {
            // æµ‹è¯•å‰ç«¯ç»„ä»¶çš„åŸºæœ¬åŠŸèƒ½
            console.log('Message components test - basic structure');
            return true;
        }

        async function testInputComponents() {
            // æµ‹è¯•è¾“å…¥ç»„ä»¶
            console.log('Input components test - basic functionality');
            return true;
        }

        async function testSettingsComponents() {
            // æµ‹è¯•è®¾ç½®ç»„ä»¶
            console.log('Settings components test - configuration options');
            return true;
        }

        async function testResponseTime() {
            const startTime = Date.now();
            const response = await fetch(`${API_BASE}/db-status`);
            const responseTime = Date.now() - startTime;
            if (responseTime > 5000) throw new Error(`Response too slow: ${responseTime}ms`);
        }

        async function testMemoryUsage() {
            if ('memory' in performance) {
                const memory = performance.memory;
                const usage = memory.usedJSHeapSize / 1024 / 1024; // MB
                console.log(`Memory usage: ${usage.toFixed(2)} MB`);
                if (usage > 100) throw new Error(`Memory usage too high: ${usage.toFixed(2)} MB`);
            }
        }

        async function testConcurrentRequests() {
            const requests = Array.from({ length: 5 }, (_, i) =>
                fetch(`${API_BASE}/db-status`)
            );
            const results = await Promise.allSettled(requests);
            const failures = results.filter(r => r.status === 'rejected');
            if (failures.length > 0) throw new Error(`${failures.length} concurrent requests failed`);
        }

        // UIæ›´æ–°å‡½æ•°
        function updateTestStatus(testName, status, error = null, duration = 0) {
            const statusDiv = document.getElementById('testStatus');
            const currentTestDiv = document.getElementById('currentTest');
            
            if (status === 'running') {
                statusDiv.classList.remove('hidden');
                currentTestDiv.textContent = testName;
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        function addTestResult(suiteName, testName, status, error = null, duration = 0) {
            const resultsDiv = document.getElementById('testResults');
            
            let suiteDiv = document.querySelector(`[data-suite="${suiteName}"]`);
            if (!suiteDiv) {
                suiteDiv = document.createElement('div');
                suiteDiv.setAttribute('data-suite', suiteName);
                suiteDiv.className = 'bg-white rounded-lg shadow-lg p-6 mb-4';
                suiteDiv.innerHTML = `
                    <h3 class="text-lg font-semibold mb-4">${suiteName}</h3>
                    <div class="space-y-2" id="suite-${suiteName.replace(/\s+/g, '-')}"></div>
                `;
                resultsDiv.appendChild(suiteDiv);
            }
            
            const testDiv = document.createElement('div');
            testDiv.className = `test-result flex items-center justify-between p-3 rounded ${
                status === 'passed' ? 'test-passed' :
                status === 'failed' ? 'test-failed' :
                status === 'running' ? 'test-running' : ''
            }`;
            
            testDiv.innerHTML = `
                <span class="text-sm font-medium">${testName}</span>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">${duration}ms</span>
                    <div class="w-3 h-3 rounded-full ${
                        status === 'passed' ? 'bg-green-500' :
                        status === 'failed' ? 'bg-red-500' :
                        status === 'running' ? 'bg-blue-500' : 'bg-gray-300'
                    }"></div>
                </div>
            `;
            
            if (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-xs text-red-600 mt-1';
                errorDiv.textContent = error;
                testDiv.appendChild(errorDiv);
            }
            
            const suiteTestsDiv = document.getElementById(`suite-${suiteName.replace(/\s+/g, '-')}`);
            suiteTestsDiv.appendChild(testDiv);
            
            testResults.push({ suiteName, testName, status, error, duration });
            updateStatistics();
        }

        function updateStatistics() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.status === 'passed').length;
            const failed = testResults.filter(r => r.status === 'failed').length;
            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('passRate').textContent = passRate + '%';
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
            updateStatistics();
            document.getElementById('testStatus').classList.add('hidden');
        }

        async function runSingleTest(suiteName, test) {
            const startTime = Date.now();
            updateTestStatus(test.name, 'running');
            addTestResult(suiteName, test.name, 'running');
            
            try {
                await test.fn();
                const duration = Date.now() - startTime;
                addTestResult(suiteName, test.name, 'passed', null, duration);
            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult(suiteName, test.name, 'failed', error.message, duration);
            }
        }

        async function runAllTests() {
            if (isRunning) return;
            
            isRunning = true;
            clearResults();
            
            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;
            runBtn.textContent = 'è¿è¡Œä¸­...';
            runBtn.classList.add('bg-gray-400');
            runBtn.classList.remove('bg-blue-500');
            
            for (const suite of testSuites) {
                for (const test of suite.tests) {
                    await runSingleTest(suite.name, test);
                    // å°å»¶è¿Ÿä½¿UIæœ‰å“åº”æ—¶é—´
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            runBtn.disabled = false;
            runBtn.textContent = 'è¿è¡Œæ‰€æœ‰æµ‹è¯•';
            runBtn.classList.remove('bg-gray-400');
            runBtn.classList.add('bg-blue-500');
            
            isRunning = false;
            updateTestStatus('', 'completed');
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            const total = testResults.length;
            const passed = testResults.filter(r => r.status === 'passed').length;
            const failed = testResults.filter(r => r.status === 'failed').length;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                failed === 0 ? 'bg-green-100 text-green-800 border-green-300' :
                'bg-red-100 text-red-800 border-red-300'
            } border`;
            alertDiv.innerHTML = `
                <div class="font-semibold">
                    ${failed === 0 ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!' : `âš ï¸ ${failed} ä¸ªæµ‹è¯•å¤±è´¥`}
                </div>
                <div class="text-sm mt-1">
                    æ€»è®¡: ${total} | é€šè¿‡: ${passed} | å¤±è´¥: ${failed}
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStatistics();
        });
    </script>
</body>
</html>