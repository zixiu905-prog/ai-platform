# AI设计平台 Web应用防火墙规则
# ModSecurity WAF配置文件

# 启用引擎
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecResponseBodyLimit 131072
SecResponseBodyMimeType text/plain text/html text/xml application/json

# 日志配置
SecRuleLog /var/log/modsec_audit.log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# 数据文件位置
SecDataDir /var/cache/modsecurity

# 核心规则集
Include /etc/modsecurity/crs/crs-setup.conf
Include /etc/modsecurity/crs/rules/*.conf

# 自定义规则集

# 1. SQL注入防护
SecRule ARGS "@detectSQLi" \
    "id:100001,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    ctl:ruleEngine=On"

# 2. XSS防护
SecRule ARGS "@detectXSS" \
    "id:100002,\
    phase:2,\
    block,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    ctl:ruleEngine=On"

# 3. 文件上传安全
SecRule FILES|FILES_NAMES "@rx \.(php|phtml|php3|php4|php5|pl|py|jsp|asp|aspx|cgi|sh|exe|bat|cmd)$" \
    "id:100003,\
    phase:2,\
    block,\
    msg:'File Upload Attack: Executable File Extension',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-file-upload'"

SecRule FILES "@pmFromFile /etc/modsecurity/file_upload_exceptions.data" \
    "id:100004,\
    phase:2,\
    allow,\
    msg:'Allowed file upload',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"

# 4. 路径遍历防护
SecRule ARGS|ARGS_NAMES|REQUEST_HEADERS|XML:/* "@rx \.\./" \
    "id:100005,\
    phase:2,\
    block,\
    msg:'Path Traversal Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-path-traversal'"

# 5. 命令注入防护
SecRule ARGS "@rx (;|\||&|`|\$\(|\$\{)" \
    "id:100006,\
    phase:2,\
    block,\
    msg:'Command Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-command-injection'"

# 6. HTTP请求方法限制
SecRule REQUEST_METHOD "!@within GET|POST|PUT|DELETE|OPTIONS|HEAD" \
    "id:100007,\
    phase:1,\
    block,\
    msg:'HTTP Request Method Not Allowed',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-protocol'"

# 7. 请求大小限制
SecRule REQUEST_HEADERS:Content-Length "@gt 10485760" \
    "id:100008,\
    phase:1,\
    block,\
    msg:'Request Content-Length Too Large',\
    logdata:'Content-Length: %{REQUEST_HEADERS:Content-Length}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"

# 8. User-Agent异常检测
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity/user_agent_blacklist.data" \
    "id:100009,\
    phase:1,\
    block,\
    msg:'Blacklisted User-Agent Detected',\
    logdata:'Matched Data: %{REQUEST_HEADERS:User-Agent}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-reputation'"

SecRule REQUEST_HEADERS:User-Agent "@rx ^$" \
    "id:100010,\
    phase:1,\
    pass,\
    log,\
    msg:'Empty User-Agent Detected',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    severity:'NOTICE'"

# 9. IP黑名单
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/modsecurity/ip_blacklist.data" \
    "id:100011,\
    phase:1,\
    block,\
    msg:'Blacklisted IP Address Detected',\
    logdata:'IP Address: %{REMOTE_ADDR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-reputation'"

# 10. 速率限制
SecAction "id:100012,phase:1,nolog,pass,t:none,setvar:ip.counter=+1,deprecatevar:ip.counter=60/60"

SecRule IP:COUNTER "@gt 100" \
    "id:100013,\
    phase:1,\
    block,\
    msg:'Rate Limit Exceeded',\
    logdata:'IP: %{REMOTE_ADDR}, Count: %{IP.COUNTER}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-dos'"

# 11. 认证绕过防护
SecRule ARGS|REQUEST_HEADERS|XML:/* "@rx (admin|administrator|root|test|guest|demo)" \
    "id:100014,\
    phase:2,\
    chain,\
    msg:'Potential Authentication Bypass Attempt',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-authentication'"
    SecRule REQUEST_FILENAME "@contains /auth/login"

# 12. 敏感信息泄露防护
SecRule RESPONSE_BODY "@pmFromFile /etc/modsecurity/sensitive_data.data" \
    "id:100015,\
    phase:4,\
    block,\
    msg:'Sensitive Data Leakage Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-information-disclosure'"

# 13. 机器人检测
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/modsecurity/bot_user_agents.data" \
    "id:100016,\
    phase:1,\
    pass,\
    log,\
    msg:'Bot User-Agent Detected',\
    logdata:'User-Agent: %{REQUEST_HEADERS:User-Agent}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    severity:'NOTICE'"

# 14. API安全规则

# JWT Token验证
SecRule REQUEST_HEADERS:Authorization "!@rx ^Bearer [A-Za-z0-9\-._~+/]+=*$" \
    "id:100017,\
    phase:1,\
    chain,\
    msg:'Invalid JWT Token Format',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REQUEST_URI "@begins_with /api/"

# API版本控制
SecRule REQUEST_URI "!@rx ^/api/v[0-9]+/" \
    "id:100018,\
    phase:1,\
    chain,\
    msg:'Invalid API Version',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REQUEST_URI "@begins_with /api/"

# Content-Type验证
SecRule REQUEST_METHOD "@within POST|PUT|PATCH" \
    "id:100019,\
    phase:1,\
    chain,\
    msg:'Missing Content-Type Header',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule &REQUEST_HEADERS:Content-Type "@eq 0"

# 15. 特定端点保护

# 管理员接口保护
SecRule REQUEST_URI "@contains /admin" \
    "id:100020,\
    phase:1,\
    chain,\
    msg:'Admin Access Attempt',\
    logdata:'IP: %{REMOTE_ADDR}, URI: %{REQUEST_URI}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REMOTE_ADDR "!@ipMatchFromFile /etc/modsecurity/admin_whitelist.data"

# 文件上传接口保护
SecRule REQUEST_URI "@contains /upload" \
    "id:100021,\
    phase:1,\
    chain,\
    msg:'File Upload Access',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REQUEST_METHOD "!@within POST|PUT"

# 数据库操作接口保护
SecRule REQUEST_URI "@contains /database" \
    "id:100022,\
    phase:1,\
    chain,\
    msg:'Database Operation Attempt',\
    logdata:'IP: %{REMOTE_ADDR}, Method: %{REQUEST_METHOD}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REMOTE_ADDR "!@ipMatchFromFile /etc/modsecurity/db_access_whitelist.data"

# 16. AI功能特定规则

# AI模型调用限制
SecRule REQUEST_URI "@contains /ai/" \
    "id:100023,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:ip.ai_counter=+1,\
    deprecatevar:ip.ai_counter=300/60"

SecRule IP:AI_COUNTER "@gt 50" \
    "id:100024,\
    phase:1,\
    block,\
    msg:'AI API Rate Limit Exceeded',\
    logdata:'IP: %{REMOTE_ADDR}, Count: %{IP.AI_COUNTER}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-dos'"

# 图像生成保护
SecRule REQUEST_URI "@contains /image/generate" \
    "id:100025,\
    phase:2,\
    chain,\
    msg:'Suspicious Image Generation Request',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule ARGS:prompt "@rx (password|secret|token|key|credential)"

# 17. 业务逻辑保护

# 订阅检查
SecRule REQUEST_URI "@contains /subscription/upgrade" \
    "id:100026,\
    phase:1,\
    chain,\
    msg:'Subscription Upgrade Attempt',\
    logdata:'IP: %{REMOTE_ADDR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer [A-Za-z0-9\-._~+/]+=*$"

# 用户操作限制
SecAction "id:100027,phase:1,nolog,pass,t:none,setvar:ip.user_ops=+1,deprecatevar:ip.user_ops=300/60"

SecRule IP:USER_OPS "@gt 200" \
    "id:100028,\
    phase:1,\
    block,\
    msg:'User Operations Rate Limit Exceeded',\
    logdata:'IP: %{REMOTE_ADDR}, Count: %{IP.USER_OPS}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-dos'"

# 18. 异常请求检测

# 异常请求头
SecRule REQUEST_HEADERS_NAMES "@rx ^[^A-Za-z0-9\-_]" \
    "id:100029,\
    phase:1,\
    block,\
    msg:'Invalid Header Name Detected',\
    logdata:'Header: %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"

# 异常参数名
SecRule ARGS_NAMES "@rx ^[^A-Za-z0-9_\-]" \
    "id:100030,\
    phase:2,\
    block,\
    msg:'Invalid Parameter Name Detected',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"

# JSON格式验证
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
    "id:100031,\
    phase:1,\
    chain,\
    msg:'Invalid JSON Format',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule REQUEST_BODY "!@validateJson"

# 19. 地理位置限制
SecRule REMOTE_ADDR "@geoLookup" \
    "id:100032,\
    phase:1,\
    chain,\
    msg:'Blocked Country Access',\
    logdata:'Country: %{GEO.COUNTRY}, IP: %{REMOTE_ADDR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi'"
    SecRule GEO:COUNTRY "@pmFromFile /etc/modsecurity/country_blacklist.data"

# 20. 时间窗口限制
SecRule REQUEST_URI "@contains /api/" \
    "id:100033,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:ip.api_requests_%{TIME_HOUR}=+1"

SecRule IP:API_REQUESTS_%{TIME_HOUR} "@gt 1000" \
    "id:100034,\
    phase:1,\
    block,\
    msg:'Hourly API Request Limit Exceeded',\
    logdata:'IP: %{REMOTE_ADDR}, Hour: %{TIME_HOUR}, Count: %{IP.API_REQUESTS_%{TIME_HOUR}}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-dos'"

# 异常处理规则
SecDefaultAction "phase:2,log,deny,status:403,msg:'Web Application Firewall Block'"