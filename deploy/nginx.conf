# Nginx configuration for AI Platform downloads

server {
    listen 80;
    server_name www.aidesign.ltd;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.aidesign.ltd;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/aidesign.ltd.crt;
    ssl_certificate_key /etc/nginx/ssl/aidesign.ltd.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Root directory
    root /var/www/aidesign.ltd;

    # Index files
    index index.html index.htm;

    # Download directory
    location /downloads/ {
        alias /var/www/aidesign.ltd/downloads/;
        autoindex off;
        autoindex_format json;

        # CORS headers
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "*";

        # Cache control
        add_header Cache-Control "public, max-age=31536000";
        expires 1y;

        # Download as attachment
        types {
            application/octet-stream exe msi;
        }

        # Logging
        access_log /var/log/nginx/downloads-access.log;
        error_log /var/log/nginx/downloads-error.log;
    }

    # Releases directory
    location /releases/ {
        alias /var/www/aidesign.ltd/releases/;
        autoindex off;

        # CORS headers
        add_header Access-Control-Allow-Origin *;

        # Cache control
        add_header Cache-Control "public, max-age=31536000";
        expires 1y;

        # Version API
        location = /releases/latest.json {
            alias /var/www/aidesign.ltd/releases/latest.json;
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
        }

        # Release info API
        location = /releases/info/ {
            alias /var/www/aidesign.ltd/releases/release-info.json;
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
        }

        # Logging
        access_log /var/log/nginx/releases-access.log;
        error_log /var/log/nginx/releases-error.log;
    }

    # Version API endpoint
    location /api/version {
        alias /var/www/aidesign.ltd/releases/latest.json;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # Main website
    location / {
        try_files $uri $uri/ =404;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Logging
    access_log /var/log/nginx/aidesign-access.log;
    error_log /var/log/nginx/aidesign-error.log;
}
